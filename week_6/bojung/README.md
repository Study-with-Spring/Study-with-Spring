# Week 6 -   로그인 처리

**프로젝트 구조**

domain (핵심 비즈니스 업무 영역)

- item
- member
- login

web (화면, UI, 기술 인프라 등)

- item
- member
- login

**중요한 건 도메인**: 

향후 web을 다른 기술로 바꾸어도 도메인은 그대로 유지할 수 있어야 하며, domain이 web을 참조해서는 안된다.

### 쿠키

쿼리 파라미터를 계속 유지하면서 보내는 것은 매우 어렵고 번거로운 작업이다. 응답에 쿠키를 담아 브라우저로 전달하면 다음 요청에서 해당 쿠키를 지속적으로 받을 수 있다.

회원과 비회원의 홈 화면은 따로 생성한다. 여기서 회원의 홈 화면은 쿠키 정보를 받아 회원 정보를 출력할 수 있다.

******************쿠키의 보안문제******************

- 쿠키 값은 임의 변경 가능
- 쿠키에 보관된 정보는 보안이 되어있지 않다.

대안 →

- 쿠키에 사용자 별로 예측 불가능한 임의의 토큰을 노출하고, 서버에서 매핑하여 인식한다.
- 토큰의 만료시간을 짧게 유지한다.

### 세션

- 서버에 중요한 정보를 세션 보관소에 보관하고 연결을 유지하는 방법
- 추정 불가능한 세션 ID만 쿠키를 통해 클라이언트에 전달한다.
- 서버에서는 클라이언트가 전달한 쿠키 정보로 세션 저장소를 조회해서 로그인시 보관한 세션 정보를 사용한다.
- session_id : value

### HttpSession

서블릿을 통해 HttpSession 을 생성하면 다음과 같은 쿠키를 생성한다. 쿠키 이름이 JSESSIONID 이고, 값은 추정 불가능한 랜덤 값이다.

`Cookie: JSESSIONID=5B78E23B513F50164D6FDD8C97B0AD05`

```java
//세션이 있으면 있는 세션 반환, 없으면 신규 세션 생성
HttpSession session = request.getSession();

//세션에 로그인 회원 정보 보관
session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);

//세션 삭제
session.invalidate();

//이미 로그인 된 사용자를 찾을 때는 다음과 같이 사용한다.
@SessionAttribute(name = "loginMember", required = false) Member loginMember
```

**세션 정보**

sessionId : 세션Id, JSESSIONID 의 값이다. 예) 34B14F008AA3527C9F8ED620EFD7A4E1 

maxInactiveInterval : 세션의 유효 시간, 예) 1800초, (30분)

creationTime : 세션 생성일시

lastAccessedTime :세션과 연결된 사용자가 최근에 서버에 접근한 시간, 클라이언트에서 서버로 sessionId ( JSESSIONID )를 요청한 경우에 갱신된다.

isNew : 새로 생성된 세션인지, 아니면 이미 과거에 만들어졌고, 클라이언트에서 서버로 sessionId ( JSESSIONID )를 요청해서 조회된 세션인지 여부

---

### 서블릿 필터

공통 관심사(cross-citing concern) :

애플리케이션 여러 로직에서 공통으로 관심이 잇는 것.

강의에서는 등록, 수정, 삭제, 조회 등등 여러 로직에서 공통으로 인증에 대해서 관심을 가지고 있다.

필터 흐름

HTTP 요청 → WAS → 필터 → 서블릿 → 컨트롤러

필터 제한

회원 : HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러

비회원 : HTTP 요청 -> WAS -> 필터(적절하지 않은 요청이라 판단, 서블릿 호출X)

필터 인터페이스를 구현하고 등록하면 서블릿 컨테이너가 필터를 싱글톤 객체로 생성하고, 관리한다. 

init(): 필터 초기화 메서드, 서블릿 컨테이너가 생성될 때 호출된다.

doFilter(): 고객의 요청이 올 때 마다 해당 메서드가 호출된다. 필터의 로직을 구현하면 된다. 

destroy(): 필터 종료 메서드, 서블릿 컨테이너가 종료될 때 호출된다.

인증 체크

`whitelist = {"/", "/members/add", "/login", "/logout","/css/*"};`

화이트 리스트 경로는 인증과 무관하게 항상 허용한다. 화이트 리스트를 제외한 나머지 모든 경로에는 인증 체크 로직을 적용한다.

`isLoginCheckPath(requestURI)`

화이트 리스트를 제외한 모든 경우에 인증 체크 로직을 적용한다.

### 인터셉터

서블릿 필터와 같이 웹과 관련된 공통 관심 사항을 효과적으로 해결할 수 있는 기술이다. 스프링 MVC가 제공하는 기술이다. 

흐름

HTTP 요청 → WAS → 필터 → 서블릿 → 스프링 인터셉터 → 컨트롤러